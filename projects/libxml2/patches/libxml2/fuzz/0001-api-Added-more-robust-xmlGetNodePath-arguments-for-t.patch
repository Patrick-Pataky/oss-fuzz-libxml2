From 696c450c33534d8de1f3dda4bb72221107b6cf8a Mon Sep 17 00:00:00 2001
From: Patrick-Pataky <patrick.pataky@epfl.ch>
Date: Wed, 14 May 2025 12:10:47 +0200
Subject: [PATCH] [api] Added more robust xmlGetNodePath arguments for testing

---
 fuzz/api.c | 91 ++++++++++++++++++++++++++++++++++++++++++++++++++++--
 1 file changed, 89 insertions(+), 2 deletions(-)

diff --git a/fuzz/api.c b/fuzz/api.c
index ba738db4..c684cce8 100644
--- a/fuzz/api.c
+++ b/fuzz/api.c
@@ -1709,11 +1709,98 @@ LLVMFuzzerTestOneInput(const char *data, size_t size) {
                 break;
 
             case OP_XML_GET_NODE_PATH: {
-                xmlChar *path;
+                xmlChar *path = NULL;
+                xmlNodePtr node, parent;
+                int select = 0;
 
                 incStrIdx();
                 startOp("xmlGetNodePath");
-                path = xmlGetNodePath(getNode(0));
+
+                node = getNode(0);
+                select = getInt(0) % 9;
+
+                if (node != NULL) {
+                    switch (select) {
+                        case 0:
+                            /* use node as is */
+                            break;
+
+                        case 1:
+                            /* use node->children */
+                            node = node->children;
+                            break;
+
+                        case 2:
+                            /* use node->last */
+                            node = node->last;
+                            break;
+
+                        case 3:
+                            /* use node->parent */
+                            node = node->parent;
+                            break;
+
+                        case 4:
+                            /* use node->next */
+                            node = node->next;
+                            break;
+
+                        case 5:
+                            /* use node->prev */
+                            node = node->prev;
+                            break;
+
+                        case 6:
+                            /* select child node with siblings (middle) */
+                            parent = node;
+                            if (parent != NULL && parent->children != NULL) {
+                                int siblingCount = 0;
+                                xmlNodePtr sibling;
+
+                                for (sibling = parent->children; sibling != NULL; sibling = sibling->next) {
+                                    siblingCount++;
+                                }
+
+                                /* select middle child if multiple exist */
+                                if (siblingCount > 1) {
+                                    int idx = siblingCount / 2;
+                                    node = parent->children;
+                                    for (int j = 0; j < idx && node != NULL; j++) {
+                                        node = node->next;
+                                    }
+                                } else {
+                                    node = parent->children;
+                                }
+                            }
+                            break;
+
+                        case 7:
+                            /* select child node with siblings (end) */
+                            parent = node;
+                            if (parent != NULL && parent->children != NULL) {
+                                xmlNodePtr last = node->children;
+
+                                /* select end child if multiple exist */
+                                while (last != NULL && last->next != NULL) {
+                                    last = last->next;
+                                }
+                                node = last;
+                            }
+                            break;
+
+                        case 8:
+                            /* get document root */
+                            while (node != NULL && node->parent != NULL) {
+                                node = node->parent;
+                            }
+                            break;
+
+                        default:
+                            break;
+                    }
+                }
+
+                path = xmlGetNodePath(node);
                 if (path != NULL)
                     oomReport = 0;
                 moveStr(0, path);
-- 
2.49.0

